{% extends "base.html" %}

{% block title %}Compras de Ativos{% endblock %}

{% block content %}
<!-- T-023.1: Inflow List with Filters and Pagination -->
<div class="container mx-auto px-4 py-6 space-y-6">

  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-display font-bold text-text-primary mb-2">
        <i class="bi bi-cart-plus text-gradient-success"></i>
        Compras de Ativos
      </h1>
      <p class="text-sm text-text-secondary">
        Gerencie suas compras e subscrições de ativos
      </p>
    </div>

    {% include "components/ui/_button.html" with text="Nova Compra" href="/inflows/create/" variant="success" icon="bi-plus-circle" size="md" %}
  </div>

  <!-- Filters Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="text-lg font-semibold text-text-primary">
        <i class="bi bi-funnel"></i>
        Filtros
      </h3>
    </div>
    <div class="card-body">
      <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4" x-data="{ hasFilters: {{ request.GET.ticker|default:'false' }} || {{ request.GET.broker|default:'false' }} || {{ request.GET.date_from|default:'false' }} || {{ request.GET.date_to|default:'false' }} }">

        <!-- Ticker Filter -->
        <div>
          <label for="ticker" class="label">Ticker</label>
          <select name="ticker" id="ticker" class="select">
            <option value="">Todos os tickers</option>
            {% for ticker in tickers %}
              <option value="{{ ticker.id }}" {% if request.GET.ticker == ticker.id|stringformat:"s" %}selected{% endif %}>
                {{ ticker.symbol }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Broker Filter -->
        <div>
          <label for="broker" class="label">Corretora</label>
          <select name="broker" id="broker" class="select">
            <option value="">Todas as corretoras</option>
            {% for broker in brokers %}
              <option value="{{ broker.id }}" {% if request.GET.broker == broker.id|stringformat:"s" %}selected{% endif %}>
                {{ broker.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Date From Filter -->
        <div>
          <label for="date_from" class="label">Data Inicial</label>
          <input type="date" name="date_from" id="date_from" value="{{ request.GET.date_from }}" class="input">
        </div>

        <!-- Date To Filter -->
        <div>
          <label for="date_to" class="label">Data Final</label>
          <input type="date" name="date_to" id="date_to" value="{{ request.GET.date_to }}" class="input">
        </div>

        <!-- Filter Actions -->
        <div class="md:col-span-4 flex items-center gap-3">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i>
            Filtrar
          </button>
          <a href="{% url 'inflow_list' %}" class="btn btn-ghost" x-show="hasFilters">
            <i class="bi bi-x-circle"></i>
            Limpar Filtros
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Inflows Table -->
  {% if inflows %}
    <div class="overflow-x-auto rounded-xl border border-border-default">
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Ticker</th>
            <th>Tipo</th>
            <th class="text-right">Quantidade</th>
            <th class="text-right">Preço/Cota</th>
            <th class="text-right">Total</th>
            <th>Corretora</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for inflow in inflows %}
            <tr>
              <!-- Date -->
              <td class="whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <i class="bi bi-calendar3 text-text-muted"></i>
                  <span>{{ inflow.date|date:"d/m/Y" }}</span>
                </div>
              </td>

              <!-- Ticker -->
              <td>
                <a href="{% url 'ticker_details' inflow.ticker.category.title inflow.ticker.id %}"
                   class="font-semibold text-brand-primary hover:text-brand-secondary transition-colors">
                  {{ inflow.ticker.symbol }}
                </a>
              </td>

              <!-- Type -->
              <td>
                {% if inflow.type == "Compra" %}
                  {% include "components/ui/_badge.html" with text="Compra" variant="success" icon="bi-cart-plus" %}
                {% else %}
                  {% include "components/ui/_badge.html" with text="Subscrição" variant="primary" icon="bi-file-earmark-plus" %}
                {% endif %}
              </td>

              <!-- Quantity -->
              <td class="text-right font-medium">
                {{ inflow.quantity }} un.
              </td>

              <!-- Cost Price -->
              <td class="text-right">
                <span class="text-text-secondary">R$</span>
                <span class="font-medium">{{ inflow.cost_price|floatformat:2 }}</span>
              </td>

              <!-- Total Price -->
              <td class="text-right">
                <span class="text-emerald-400 font-semibold">
                  R$ {{ inflow.total_price|floatformat:2 }}
                </span>
              </td>

              <!-- Broker -->
              <td>
                <div class="flex items-center gap-2">
                  <i class="bi bi-building text-text-muted"></i>
                  <span>{{ inflow.broker.name|default:"N/A" }}</span>
                </div>
              </td>

              <!-- Actions -->
              <td>
                <div class="flex items-center justify-center gap-2">
                  {% include "components/ui/_button.html" with href="/inflows/"|add:inflow.id|add:"/details/" variant="ghost" icon="bi-eye" size="sm" class="btn-icon" %}
                  {% include "components/ui/_button.html" with href="/inflows/"|add:inflow.id|add:"/update/" variant="ghost" icon="bi-pencil" size="sm" class="btn-icon" %}
                  <button @click="deleteModal = {{ inflow.id }}" class="btn btn-ghost btn-sm btn-icon">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <nav aria-label="Navegação de páginas" class="flex flex-col sm:flex-row items-center justify-between gap-4">

        <!-- Pagination Info -->
        <p class="text-sm text-text-secondary">
          Mostrando <span class="font-medium text-text-primary">{{ page_obj.start_index }}</span> -
          <span class="font-medium text-text-primary">{{ page_obj.end_index }}</span> de
          <span class="font-medium text-text-primary">{{ page_obj.paginator.count }}</span> compras
        </p>

        <!-- Pagination Controls -->
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="pagination-item" aria-label="Primeira página">
              <i class="bi bi-chevron-bar-left"></i>
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="pagination-item" aria-label="Página anterior">
              <i class="bi bi-chevron-left"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-bar-left"></i>
            </span>
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-left"></i>
            </span>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="pagination-item-active">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                 class="pagination-item">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="pagination-item" aria-label="Próxima página">
              <i class="bi bi-chevron-right"></i>
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="pagination-item" aria-label="Última página">
              <i class="bi bi-chevron-bar-right"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-right"></i>
            </span>
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-bar-right"></i>
            </span>
          {% endif %}
        </div>
      </nav>
    {% endif %}

  {% else %}
    <!-- Empty State -->
    {% include "components/ui/_empty_state.html" with icon="bi-cart-x" title="Nenhuma compra registrada" description="Comece registrando sua primeira compra de ativos para acompanhar seu portfólio." action_text="Registrar Compra" action_href="/inflows/create/" action_variant="success" %}
  {% endif %}

</div>

<!-- Delete Confirmation Modal -->
<div x-data="{ deleteModal: null }">
  <template x-if="deleteModal">
    <div class="modal-backdrop"
         x-show="deleteModal !== null"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="deleteModal = null">
    </div>

    <div class="modal"
         x-show="deleteModal !== null"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95">

      <div class="modal-content max-w-md">
        <div class="modal-header">
          <h3 class="text-lg font-semibold text-text-primary">
            <i class="bi bi-exclamation-triangle text-red-400"></i>
            Confirmar Exclusão
          </h3>
          <button @click="deleteModal = null" class="text-text-secondary hover:text-text-primary transition-colors">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>

        <div class="modal-body">
          <p class="text-text-secondary">
            Tem certeza que deseja excluir esta compra? Esta ação não pode ser desfeita.
          </p>
        </div>

        <div class="modal-footer">
          <button @click="deleteModal = null" class="btn btn-secondary">
            Cancelar
          </button>
          <a :href="`/inflows/${deleteModal}/delete/`" class="btn btn-danger">
            <i class="bi bi-trash"></i>
            Excluir Compra
          </a>
        </div>
      </div>
    </div>
  </template>
</div>

{% endblock %}