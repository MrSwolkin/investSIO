{% extends "base.html" %}

{% block title %}Dividendos - InvestSIO{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
  <h1 class="text-3xl font-display font-bold text-text-primary mb-2">Dividendos</h1>
  <p class="text-text-secondary">Gerencie seus dividendos recebidos</p>
</div>

<!-- Filters and Actions Bar -->
<div class="flex flex-col gap-4 mb-6">
  <!-- Top Row: Search + Create Button -->
  <div class="flex flex-col md:flex-row gap-4">
    <!-- Search Form -->
    <div class="flex-1 max-w-md">
      <form method="get" action="{% url 'dividend_list' %}" class="relative">
        <input
          type="text"
          name="ticker"
          placeholder="Buscar por ticker..."
          value="{{ request.GET.ticker }}"
          class="input pl-10"
        >
        <button
          type="submit"
          class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted hover:text-text-primary transition-colors"
          aria-label="Buscar"
        >
          <i class="bi bi-search"></i>
        </button>
      </form>
    </div>

    <!-- Create Button -->
    <div>
      {% include "components/ui/_button.html" with text="Novo Dividendo" icon="bi-plus-circle" variant="primary" href="/dividends/create/" %}
    </div>
  </div>

  <!-- Bottom Row: Advanced Filters -->
  <div class="card">
    <div class="card-body py-4">
      <form method="get" action="{% url 'dividend_list' %}" class="flex flex-col md:flex-row gap-3">
        <!-- Month Filter -->
        <div class="flex-1">
          <select name="month" class="select">
            <option value="">Todos os meses</option>
            {% for mes_num, mes_nome in meses.items %}
              <option value="{{ mes_num }}" {% if request.GET.month == mes_num|stringformat:'i' %}selected{% endif %}>
                {{ mes_nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Year Filter -->
        <div class="flex-1">
          <select name="year" class="select">
            <option value="">Todos os anos</option>
            {% for ano in anos %}
              <option value="{{ ano }}" {% if request.GET.year == ano|stringformat:"i" %}selected{% endif %}>
                {{ ano }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Filter Button -->
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-filter"></i>
          Filtrar
        </button>

        <!-- Clear Filters -->
        {% if request.GET.month or request.GET.year or request.GET.ticker %}
          <a href="{% url 'dividend_list' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i>
            Limpar
          </a>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- Dividends List -->
{% if dividends %}
  <div class="overflow-x-auto rounded-xl border border-border-default">
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Ticker</th>
          <th>Tipo</th>
          <th>Moeda</th>
          <th class="text-right">Valor por Cota</th>
          <th class="text-center">Quantidade</th>
          <th class="text-right">Valor Total</th>
          <th class="text-center w-40">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for dividend in dividends %}
          <tr x-data="{ showDeleteModal: false }">
            <td class="font-mono text-text-muted">{{ dividend.date|date:"d/m/Y" }}</td>
            <td class="font-medium text-text-primary">
              <div class="flex items-center gap-2">
                <i class="bi bi-cash-coin text-blue-400"></i>
                {{ dividend.ticker }}
              </div>
            </td>
            <td>
              {% if dividend.income_type == "Dividendo" %}
                <span class="badge badge-primary">{{ dividend.income_type }}</span>
              {% elif dividend.income_type == "JCP" %}
                <span class="badge badge-success">{{ dividend.income_type }}</span>
              {% elif dividend.income_type == "Rendimento" %}
                <span class="badge badge-warning">{{ dividend.income_type }}</span>
              {% else %}
                <span class="badge badge-neutral">{{ dividend.income_type }}</span>
              {% endif %}
            </td>
            <td>
              <span class="badge badge-neutral">{{ dividend.currency }}</span>
            </td>
            <td class="text-right font-mono text-text-primary">R$ {{ dividend.value|floatformat:2 }}</td>
            <td class="text-center text-text-secondary">{{ dividend.quantity_quote }}</td>
            <td class="text-right font-mono text-text-primary font-semibold">R$ {{ dividend.total_value|floatformat:2 }}</td>
            <td>
              <div class="flex items-center justify-center gap-2">
                <!-- View Button (optional, if you have a details page) -->
                <!-- {% include "components/ui/_button.html" with icon="bi-eye" variant="ghost" size="sm" href="/dividends/"|add:dividend.id|add:"/details/" class="btn-icon" %} -->

                <!-- Edit Button -->
                {% include "components/ui/_button.html" with icon="bi-pencil" variant="ghost" size="sm" href="/dividends/"|add:dividend.id|add:"/update/" class="btn-icon" %}

                <!-- Delete Button -->
                <button
                  @click="showDeleteModal = true"
                  class="btn btn-ghost btn-sm btn-icon"
                  aria-label="Excluir"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>

              <!-- Delete Confirmation Modal -->
              <template x-if="showDeleteModal">
                <div>
                  <!-- Backdrop -->
                  <div
                    class="modal-backdrop"
                    x-show="showDeleteModal"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0"
                    x-transition:enter-end="opacity-100"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100"
                    x-transition:leave-end="opacity-0"
                    @click="showDeleteModal = false"
                  ></div>

                  <!-- Modal Dialog -->
                  <div
                    class="modal"
                    x-show="showDeleteModal"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 scale-95"
                    x-transition:enter-end="opacity-100 scale-100"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100 scale-100"
                    x-transition:leave-end="opacity-0 scale-95"
                    @click.self="showDeleteModal = false"
                  >
                    <div class="modal-content max-w-md">
                      <!-- Modal Header -->
                      <div class="modal-header">
                        <div class="flex items-center gap-3">
                          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-red-500/20">
                            <i class="bi bi-exclamation-triangle text-red-400 text-xl"></i>
                          </div>
                          <h3 class="text-lg font-semibold text-text-primary">Confirmar Exclusão</h3>
                        </div>
                        <button
                          @click="showDeleteModal = false"
                          class="text-text-secondary hover:text-text-primary transition-colors"
                        >
                          <i class="bi bi-x-lg text-xl"></i>
                        </button>
                      </div>

                      <!-- Modal Body -->
                      <div class="modal-body">
                        <p class="text-text-secondary mb-4">
                          Tem certeza que deseja excluir o dividendo de <strong class="text-text-primary">{{ dividend.ticker }}</strong> recebido em <strong class="text-text-primary">{{ dividend.date|date:"d/m/Y" }}</strong>?
                        </p>
                        <div class="alert alert-warning">
                          <i class="bi bi-info-circle-fill"></i>
                          <p class="text-sm">Esta ação não pode ser desfeita. O registro de dividendo será permanentemente removido.</p>
                        </div>
                      </div>

                      <!-- Modal Footer -->
                      <div class="modal-footer">
                        <button
                          @click="showDeleteModal = false"
                          class="btn btn-secondary"
                        >
                          Cancelar
                        </button>
                        <a
                          href="{% url 'dividend_delete' dividend.id %}"
                          class="btn btn-danger"
                        >
                          <i class="bi bi-trash"></i>
                          Excluir
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Navegação de páginas" class="mt-6">
      <div class="flex items-center justify-between">
        <!-- Page Info -->
        <p class="text-sm text-text-secondary">
          Mostrando <span class="font-medium text-text-primary">{{ page_obj.start_index }}</span> -
          <span class="font-medium text-text-primary">{{ page_obj.end_index }}</span> de
          <span class="font-medium text-text-primary">{{ page_obj.paginator.count }}</span> dividendos
        </p>

        <!-- Pagination Controls -->
        <div class="pagination">
          <!-- First Page -->
          {% if page_obj.has_previous %}
            <a
              href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Primeira página"
            >
              <i class="bi bi-chevron-double-left"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-double-left"></i>
            </span>
          {% endif %}

          <!-- Previous Page -->
          {% if page_obj.has_previous %}
            <a
              href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Página anterior"
            >
              <i class="bi bi-chevron-left"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-left"></i>
            </span>
          {% endif %}

          <!-- Page Numbers -->
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="pagination-item-active" aria-current="page">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a
                href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                class="pagination-item"
              >
                {{ num }}
              </a>
            {% endif %}
          {% endfor %}

          <!-- Next Page -->
          {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Próxima página"
            >
              <i class="bi bi-chevron-right"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-right"></i>
            </span>
          {% endif %}

          <!-- Last Page -->
          {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Última página"
            >
              <i class="bi bi-chevron-double-right"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-double-right"></i>
            </span>
          {% endif %}
        </div>
      </div>
    </nav>
  {% endif %}

{% else %}
  <!-- Empty State -->
  {% include "components/ui/_empty_state.html" with icon="bi-cash-coin" title="Nenhum dividendo cadastrado" description="Comece registrando seus primeiros dividendos recebidos." action_text="Registrar Primeiro Dividendo" action_href="/dividends/create/" action_variant="primary" %}
{% endif %}

{% endblock %}
