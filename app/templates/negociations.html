{% extends "base.html" %}

{% block title %}Negociações - InvestSIO{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
  <h1 class="text-3xl font-display font-bold text-text-primary mb-2">Negociações</h1>
  <p class="text-text-secondary">Histórico consolidado de compras, vendas e dividendos</p>
</div>

<!-- Filters Card -->
<div class="card mb-6" x-data="{ showFilters: false }">
  <div class="card-body py-4">
    <!-- Filter Toggle Button (Mobile) -->
    <button
      @click="showFilters = !showFilters"
      class="btn btn-secondary w-full mb-4 md:hidden"
    >
      <i class="bi bi-funnel"></i>
      <span x-text="showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros'"></span>
    </button>

    <!-- Filters Form -->
    <form
      method="get"
      action="{% url 'negociations' %}"
      class="gap-3"
      :class="showFilters || window.innerWidth >= 768 ? 'flex flex-col md:flex-row' : 'hidden md:flex md:flex-row'"
      x-show="showFilters || window.innerWidth >= 768"
      x-transition
    >
      <!-- Ticker Filter -->
      <div class="flex-1">
        <input
          type="text"
          name="ticker"
          placeholder="Filtrar por ticker..."
          value="{{ request.GET.ticker }}"
          class="input"
        >
      </div>

      <!-- Transaction Type Filter -->
      <div class="flex-1">
        <select name="type" class="select">
          <option value="">Todos os tipos</option>
          <option value="Compra" {% if request.GET.type == "Compra" %}selected{% endif %}>Compra</option>
          <option value="Subscrição" {% if request.GET.type == "Subscrição" %}selected{% endif %}>Subscrição</option>
          <option value="Venda" {% if request.GET.type == "Venda" %}selected{% endif %}>Venda</option>
          <option value="Dividendo" {% if request.GET.type == "Dividendo" %}selected{% endif %}>Dividendo</option>
          <option value="JCP" {% if request.GET.type == "JCP" %}selected{% endif %}>JCP</option>
          <option value="Rendimento" {% if request.GET.type == "Rendimento" %}selected{% endif %}>Rendimento</option>
        </select>
      </div>

      <!-- Date From Filter -->
      <div class="flex-1">
        <input
          type="date"
          name="date_from"
          placeholder="Data inicial"
          value="{{ request.GET.date_from }}"
          class="input"
        >
      </div>

      <!-- Date To Filter -->
      <div class="flex-1">
        <input
          type="date"
          name="date_to"
          placeholder="Data final"
          value="{{ request.GET.date_to }}"
          class="input"
        >
      </div>

      <!-- Filter Buttons -->
      <div class="flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-filter"></i>
          Filtrar
        </button>

        <!-- Clear Filters -->
        {% if request.GET.ticker or request.GET.type or request.GET.date_from or request.GET.date_to %}
          <a href="{% url 'negociations' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i>
            Limpar
          </a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <!-- Total Transactions -->
  <div class="card">
    <div class="card-body">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/20">
          <i class="bi bi-arrow-left-right text-blue-400 text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-text-secondary">Total de Transações</p>
          <p class="text-2xl font-bold text-text-primary">{{ transactions|length }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Placeholder for other stats - can be calculated in the view -->
  <div class="card">
    <div class="card-body">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500/20 to-teal-500/20">
          <i class="bi bi-graph-up text-emerald-400 text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-text-secondary">Compras</p>
          <p class="text-2xl font-bold text-emerald-400">-</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-red-500/20 to-pink-500/20">
          <i class="bi bi-graph-down text-red-400 text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-text-secondary">Vendas</p>
          <p class="text-2xl font-bold text-red-400">-</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/20">
          <i class="bi bi-cash-coin text-blue-400 text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-text-secondary">Dividendos</p>
          <p class="text-2xl font-bold text-blue-400">-</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transactions List -->
{% if transactions %}
  <div class="overflow-x-auto rounded-xl border border-border-default">
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Ticker</th>
          <th>Tipo</th>
          <th class="text-center">Quantidade</th>
          <th class="text-right">Valor por Cota</th>
          <th class="text-right">Total</th>
          <th class="text-center w-32">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
          <tr>
            <td class="font-mono text-text-muted">{{ transaction.date|date:"d/m/Y" }}</td>

            <td class="font-medium text-text-primary">
              <div class="flex items-center gap-2">
                <!-- Icon based on transaction type -->
                {% if transaction.transaction_type == "Compra" or transaction.transaction_type == "Subscrição" %}
                  <i class="bi bi-graph-up text-emerald-400"></i>
                {% elif transaction.transaction_type == "Venda" %}
                  <i class="bi bi-graph-down text-red-400"></i>
                {% else %}
                  <i class="bi bi-cash-coin text-blue-400"></i>
                {% endif %}
                {{ transaction.ticker }}
              </div>
            </td>

            <td>
              <!-- Badge based on transaction type -->
              {% if transaction.transaction_type == "Compra" %}
                <span class="badge badge-success">
                  <i class="bi bi-arrow-down-circle text-xs"></i>
                  Compra
                </span>
              {% elif transaction.transaction_type == "Subscrição" %}
                <span class="badge badge-success">
                  <i class="bi bi-plus-circle text-xs"></i>
                  Subscrição
                </span>
              {% elif transaction.transaction_type == "Venda" %}
                <span class="badge badge-danger">
                  <i class="bi bi-arrow-up-circle text-xs"></i>
                  Venda
                </span>
              {% elif transaction.transaction_type == "Dividendo" %}
                <span class="badge badge-primary">
                  <i class="bi bi-currency-dollar text-xs"></i>
                  Dividendo
                </span>
              {% elif transaction.transaction_type == "JCP" %}
                <span class="badge badge-primary">
                  <i class="bi bi-cash-stack text-xs"></i>
                  JCP
                </span>
              {% elif transaction.transaction_type == "Rendimento" %}
                <span class="badge badge-warning">
                  <i class="bi bi-percent text-xs"></i>
                  Rendimento
                </span>
              {% else %}
                <span class="badge badge-neutral">{{ transaction.transaction_type }}</span>
              {% endif %}
            </td>

            <td class="text-center text-text-secondary">
              {% if transaction.quantity %}
                {{ transaction.quantity }}
              {% else %}
                -
              {% endif %}
            </td>

            <td class="text-right font-mono text-text-primary">
              {% if transaction.cost_price %}
                R$ {{ transaction.cost_price|floatformat:2 }}
              {% else %}
                -
              {% endif %}
            </td>

            <td class="text-right font-mono font-semibold">
              {% if transaction.transaction_type == "Compra" or transaction.transaction_type == "Subscrição" %}
                <span class="text-emerald-400">R$ {{ transaction.total|floatformat:2 }}</span>
              {% elif transaction.transaction_type == "Venda" %}
                <span class="text-red-400">R$ {{ transaction.total|floatformat:2 }}</span>
              {% else %}
                <span class="text-blue-400">R$ {{ transaction.total|floatformat:2 }}</span>
              {% endif %}
            </td>

            <td>
              <div class="flex items-center justify-center gap-2">
                <!-- View Details Button -->
                {% if transaction.transaction_type == "Compra" or transaction.transaction_type == "Subscrição" %}
                  {% include "components/ui/_button.html" with icon="bi-eye" variant="ghost" size="sm" href="/inflows/"|add:transaction.id|add:"/details/" class="btn-icon" %}
                {% elif transaction.transaction_type == "Venda" %}
                  {% include "components/ui/_button.html" with icon="bi-eye" variant="ghost" size="sm" href="/outflows/"|add:transaction.id|add:"/details/" class="btn-icon" %}
                {% else %}
                  <!-- Dividends don't have a details page yet, so we can link to edit -->
                  {% include "components/ui/_button.html" with icon="bi-pencil" variant="ghost" size="sm" href="/dividends/"|add:transaction.id|add:"/update/" class="btn-icon" %}
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Navegação de páginas" class="mt-6">
      <div class="flex items-center justify-between">
        <!-- Page Info -->
        <p class="text-sm text-text-secondary">
          Mostrando <span class="font-medium text-text-primary">{{ page_obj.start_index }}</span> -
          <span class="font-medium text-text-primary">{{ page_obj.end_index }}</span> de
          <span class="font-medium text-text-primary">{{ page_obj.paginator.count }}</span> transações
        </p>

        <!-- Pagination Controls -->
        <div class="pagination">
          <!-- First Page -->
          {% if page_obj.has_previous %}
            <a
              href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Primeira página"
            >
              <i class="bi bi-chevron-double-left"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-double-left"></i>
            </span>
          {% endif %}

          <!-- Previous Page -->
          {% if page_obj.has_previous %}
            <a
              href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Página anterior"
            >
              <i class="bi bi-chevron-left"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-left"></i>
            </span>
          {% endif %}

          <!-- Page Numbers -->
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="pagination-item-active" aria-current="page">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a
                href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                class="pagination-item"
              >
                {{ num }}
              </a>
            {% endif %}
          {% endfor %}

          <!-- Next Page -->
          {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Próxima página"
            >
              <i class="bi bi-chevron-right"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-right"></i>
            </span>
          {% endif %}

          <!-- Last Page -->
          {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
              class="pagination-item"
              aria-label="Última página"
            >
              <i class="bi bi-chevron-double-right"></i>
            </a>
          {% else %}
            <span class="pagination-item-disabled">
              <i class="bi bi-chevron-double-right"></i>
            </span>
          {% endif %}
        </div>
      </div>
    </nav>
  {% endif %}

{% else %}
  <!-- Empty State -->
  {% include "components/ui/_empty_state.html" with icon="bi-arrow-left-right" title="Nenhuma transação encontrada" description="Não há transações para exibir com os filtros aplicados." %}
{% endif %}

<!-- Quick Actions Card -->
<div class="card mt-6">
  <div class="card-header">
    <h3 class="text-lg font-semibold text-text-primary">Ações Rápidas</h3>
  </div>
  <div class="card-body">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <a href="{% url 'inflow_create' %}" class="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-br from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 hover:from-emerald-500/20 hover:to-teal-500/20 transition-all group">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-500/20 group-hover:scale-110 transition-transform">
          <i class="bi bi-plus-circle text-emerald-400 text-xl"></i>
        </div>
        <div>
          <h4 class="font-semibold text-text-primary">Nova Compra</h4>
          <p class="text-xs text-text-secondary">Registrar compra de ativo</p>
        </div>
      </a>

      <a href="{% url 'outflow_create' %}" class="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-br from-red-500/10 to-pink-500/10 border border-red-500/20 hover:from-red-500/20 hover:to-pink-500/20 transition-all group">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-red-500/20 group-hover:scale-110 transition-transform">
          <i class="bi bi-dash-circle text-red-400 text-xl"></i>
        </div>
        <div>
          <h4 class="font-semibold text-text-primary">Nova Venda</h4>
          <p class="text-xs text-text-secondary">Registrar venda de ativo</p>
        </div>
      </a>

      <a href="{% url 'dividend_create' %}" class="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border border-blue-500/20 hover:from-blue-500/20 hover:to-cyan-500/20 transition-all group">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-500/20 group-hover:scale-110 transition-transform">
          <i class="bi bi-cash-coin text-blue-400 text-xl"></i>
        </div>
        <div>
          <h4 class="font-semibold text-text-primary">Novo Dividendo</h4>
          <p class="text-xs text-text-secondary">Registrar dividendo recebido</p>
        </div>
      </a>
    </div>
  </div>
</div>

{% endblock %}
